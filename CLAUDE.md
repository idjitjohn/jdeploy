# CLAUDE.md - Project Guidelines

## Build & Package Management
- Use `yarn` (not npm) for all package operations
- Run `yarn build` to compile TypeScript and bundle frontend
- Build output: `dist/` for backend, `public/js/` for frontend bundles

## TypeScript Configuration
- **Backend**: `tsconfig.server.json` - Compiles `src/server/` to `dist/`
- **Frontend**: `tsconfig.json` - Configured for browser DOM environment

## Frontend Build System
- **Bundler**: esbuild via `esbuild.config.js`
- **Format**: IIFE (Immediately Invoked Function Expression)
- **Output**: Minified single files in `public/js/`
- **Modules**: All frontend code bundles into one standalone file per page
  - `login.js` - Login form with authentication
  - `dashboard.js` - Dashboard page
  - `repositories.js` - Repository management
  - `domains.js` - Domain configuration
  - `templates.js` - Deployment templates
  - `logs.js` - Deployment logs

## Scripts (Node.js)
- Location: `scripts/` directory
- **mock.ts**: Database seeding with TypeScript (uses tsx runner)
- Run: `yarn mock` to initialize database with admin user and test data
- Test users created: dev (dev123), operator (operator123)

## Frontend Code Style
- Location: `src/frontend/` - TypeScript with browser APIs
- Files export to `window` object for global access
- API calls use `window.api` - Configured with `credentials: 'include'` for cookies
- No ES module imports in HTML - use IIFE bundles with regular `<script>` tags

## Authentication
- Method: Cookie-based JWT tokens
- Cookie settings: `httpOnly: true`, `secure: false` (dev), `path: '/'`
- Token stored in `token` cookie, sent with all API requests
- Auth endpoint: `/api/auth/me` - Check if user is authenticated
- Middleware: `authMiddleware` validates JWT from cookies

## Styling
- Framework: SCSS (Sass)
- Location: `src/scss/`
- Compilation: `sass src/scss:public/css`
- Modules: `_variables.scss`, `dashboard.scss`, `login.scss`, etc.
- Units: Use `em` for sizes (not px), except for borders and shadows
- Syntax: All property declarations must end with `;` (required for valid CSS)
- Imports: Use `@use 'variables' as *;` (not `@import` - deprecated)
- Color functions: Use `color.adjust()` instead of deprecated `darken()`

## API Layer
- Base URL: Relative (empty string) - requests go to same host
- All requests: `credentials: 'include'` to send cookies
- 401 errors: Throw error (no auto-redirect from API layer)
  - `checkAuth()` function handles redirects on protected pages
  - Login page doesn't redirect on 401 (already there)

## Database
- Provider: MongoDB
- Connection: Via mongoose (connection string in `.env` or default)
- Models: Located in `src/server/models/`
- Exported names: `User`, `RepositoryModel`, `DomainModel`, `Template`, `Configuration`, `DeploymentLogModel`

## Project Structure
```
src/
├── server/          # Backend (TypeScript)
│   ├── index.ts     # Main Fastify server
│   ├── models/      # Mongoose schemas
│   ├── routes/      # API routes
│   ├── middleware/  # Auth, error handling
│   ├── services/    # Business logic
│   ├── socket/      # WebSocket handlers
│   └── utils/       # Helpers
├── frontend/        # Frontend (TypeScript, compiled to IIFE)
│   ├── login.ts
│   ├── dashboard.ts
│   ├── api.ts       # API client
│   ├── utils.ts     # Helper functions
│   └── *.ts         # Page-specific code
└── scss/            # Styles
    ├── _variables.scss
    ├── main.scss
    ├── login.scss
    └── *.scss

public/             # Static files
├── index.html       # Login page
├── dashboard.html   # Dashboard page
├── *.html           # Other pages
├── css/             # Compiled styles
└── js/              # Bundled frontend (IIFE format)

dist/               # Compiled backend (generated by tsc)
```

## Common Tasks
- `yarn build` - Full build (TypeScript + frontend + SCSS)
- `yarn build:ts` - Compile TypeScript backend only
- `yarn build:frontend` - Bundle frontend with esbuild
- `yarn build:scss` - Compile SCSS to CSS
- `yarn build:watch` - Watch mode for development
- `yarn dev` - Development: watch + nodemon
- `yarn mock` - Initialize database with seed data
- `yarn start` - Run production build
