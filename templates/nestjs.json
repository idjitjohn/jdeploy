{
  "name": "NestJS",
  "description": "NestJS backend API",
  "commands": [
    "cd $cf$",
    "git fetch origin $branch$",
    "git checkout $branch$",
    "git reset --hard origin/$branch$",
    "yarn install",
    "yarn build",
    "rm -rf $rf$/dist $rf$/package.json $rf$/yarn.lock $rf$/.env*",
    "cp -r $cf$/dist $rf$/",
    "cp $cf$/package.json $rf$/",
    "cp $cf$/yarn.lock $rf$/ 2>/dev/null || cp $cf$/package-lock.json $rf$/ 2>/dev/null || true",
    "cp $cf$/.env* $rf$/ 2>/dev/null || true"
  ],
  "preDeploy": [],
  "postDeploy": [
    "cd $rf$",
    "yarn install --production",
    "pm2 delete $pm2Name$ 2>/dev/null || true",
    "pm2 start dist/main.js --name $pm2Name$ --namespace \"$port$\" --cwd $rf$"
  ],
  "nginx": {
    "enabled": true,
    "template": [
      "ssl_certificate $home$/certificate/$domain$/certificate.crt;",
      "ssl_certificate_key $home$/certificate/$domain$/private.key;",
      "",
      "server {",
      "  listen 80;",
      "  server_name $name$.$domain$ www.$name$.$domain$;",
      "  return 301 https://$server_name$request_uri;",
      "}",
      "",
      "server {",
      "  listen 443 ssl http2;",
      "  server_name $name$.$domain$ www.$name$.$domain$;",
      "",
      "  ssl_protocols TLSv1.2 TLSv1.3;",
      "  ssl_ciphers HIGH:!aNULL:!MD5;",
      "  ssl_prefer_server_ciphers on;",
      "",
      "  gzip on;",
      "  gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;",
      "",
      "  location / {",
      "    proxy_set_header Host $host;",
      "    proxy_set_header X-Real-IP $remote_addr;",
      "    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;",
      "    proxy_set_header X-Forwarded-Proto $scheme;",
      "    proxy_pass http://localhost:$port$;",
      "    proxy_redirect off;",
      "  }",
      "}"
    ]
  },
  "env": {
    "NODE_ENV": "$type$"
  }
}
